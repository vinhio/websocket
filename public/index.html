<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>gFly WebSocket</title>
    <link rel="icon" href="favicon.png"/>

    <script src="msgpack.min.js"></script>
    <script src="websocket.js"></script>
    <script type="text/javascript">
      "use strict";
      const msgSystem = {
        // "metadata": {
        //   "version": "1.0",
        //   "timestamp": "2025-04-18T15:30:45.123Z",
        //   "server_node": {
        //     "id": "node-123",
        //     "region": "us-west-2",
        //     "load": 0.75
        //   }
        // },
        // "channel": {
        //   "id": "ch_8f72a1b9",
        //   "type": "direct", // or "group", "public", etc.
        //   "participants": [
        //     {
        //       "user_id": "usr_42abc",
        //       "username": "alice_smith",
        //       "status": "online",
        //       "joined_at": "2025-04-18T15:28:12.422Z"
        //     },
        //     {
        //       "user_id": "usr_57xyz",
        //       "username": "bob_jones",
        //       "status": "online",
        //       "joined_at": "2025-04-18T15:29:01.735Z"
        //     }
        //   ],
        //   "created_at": "2025-04-18T15:28:12.422Z",
        //   "updated_at": "2025-04-18T15:30:45.123Z"
        // },
        "message": {
          "id": "msg_9e83f2c7",
          "sender_id": "usr_42abc",
          "timestamp": "2025-04-18T15:30:45.123Z",
          "type": "text", // could be "text", "file", "image", "video", etc.
          "content": {
            "text": "Hey, how are you doing today?"
          },
          "status": "delivered", // could be "sent", "delivered", "read", "failed"
          "reactions": []
        }
      };

      window.onload = function () {
        let conn;
        const msg = document.getElementById("msg");
        const log = document.getElementById("log");
        const channelSelect = document.getElementById("channel");
        const currentChannel = document.getElementById("currentChannel");

        function appendLog(item) {
          const doScroll =
                  log.scrollTop > log.scrollHeight - log.clientHeight - 1;
          log.appendChild(item);
          if (doScroll) {
            log.scrollTop = log.scrollHeight - log.clientHeight;
          }
        }

        document.getElementById("form").onsubmit = function () {
          if (!conn) {
            return false;
          }
          if (!msg.value) {
            return false;
          }

          // TODO Build message
          //msgSystem.channel.id = channelSelect.value;
          msgSystem.message.content.text = msg.value;
          const msgPackSystem = msgpack.encode(msgSystem);

          console.log(msgPackSystem);

          conn.send(msgPackSystem);
          msg.value = "";

          return false;
        };

        // Function to connect to a specific channel
        // This function has been improved to maintain the WebSocket connection when switching channels
        // Instead of closing and reopening the connection, it now sends a channel switch command
        // to the server, which allows the server to move the client to a different channel
        // without disconnecting the WebSocket connection.
        function connectToChannel(channel) {
          // Update current channel display
          currentChannel.textContent = channel || "General";

          if (!conn || conn.readyState !== WebSocket.OPEN) {
            // If no connection exists or it's not open, create a new one
            // This happens on the initial connection or if the connection was closed
            const wsUrl = "ws://" + document.location.host + "/ws" + (channel ? "?channel=" + encodeURIComponent(channel) : "");
            conn = new ReconnectingWebSocket(wsUrl);
            conn.debug = true;

            conn.onopen = function (evt) {
                const item = document.createElement("div");
                item.innerHTML = "<b>Connected to channel: " + (channel || "General") + "</b>";
                appendLog(item);
            };

            conn.onclose = function (evt) {
              const item = document.createElement("div");
              item.innerHTML = "<b>Connection closed.</b>";
              appendLog(item);
            };

            conn.onmessage = function (evt) {
              console.log(evt.data);
              // https://stackoverflow.com/questions/36153238/sending-binary-data-over-websocket-with-cowboy-and-messagepack
              // var raw_binary_data = new Uint8Array(evt.data);
              // var message = msgpack.decode(raw_binary_data);

              const messages = evt.data.split("\n");
              for (let i = 0; i < messages.length; i++) {
                try {
                  const msg = msgpack.decode(messages[i]);
                  // TODO just append full message
                  console.log(msg);

                  const item = document.createElement("div");
                  item.innerText = msg.message.content.text;

                  appendLog(item);
                } catch (e) {
                  console.log(e);
                }
              }
            };
          } else {
            // If connection exists and is open, send a channel switch command
            // This is the key improvement: instead of closing and reopening the connection,
            // we send a command to the server to switch channels while maintaining the connection

            conn.send("/switch " + (channel || "default"));

            const item = document.createElement("div");
            item.innerHTML = "<b>Switching to channel: " + (channel || "General") + "</b>";
            appendLog(item);
          }
        }

        // Handle channel selection change
        channelSelect.addEventListener("change", function() {
          const selectedChannel = channelSelect.value;
          connectToChannel(selectedChannel);
        });

        // Handle new channel button click
        document.getElementById("newChannelBtn").addEventListener("click", function() {
          const channelName = prompt("Enter new channel name:");
          if (channelName) {
            // Check if the channel already exists
            let channelExists = false;
            for (let i = 0; i < channelSelect.options.length; i++) {
              if (channelSelect.options[i].value === channelName) {
                channelExists = true;
                channelSelect.selectedIndex = i;
                break;
              }
            }

            // If the channel doesn't exist, add it
            if (!channelExists) {
              const option = document.createElement("option");
              option.value = channelName;
              option.text = channelName;
              channelSelect.add(option);
              channelSelect.value = channelName;
            }

            // Connect to the new channel
            connectToChannel(channelName);
          }
        });

        // Initial connection
        if (window["WebSocket"]) {
          // Get channel from URL if present
          const urlParams = new URLSearchParams(window.location.search);
          const channelParam = urlParams.get('channel');

          // Set the select value if channel is in URL
          if (channelParam) {
            // Check if the channel exists in the dropdown
            for (let i = 0; i < channelSelect.options.length; i++) {
              if (channelSelect.options[i].value === channelParam) {
                channelSelect.selectedIndex = i;
                break;
              }
            }
            // If not found, add it
            if (channelSelect.value !== channelParam) {
              const option = document.createElement("option");
              option.value = channelParam;
              option.text = channelParam;
              channelSelect.add(option);
              channelSelect.value = channelParam;
            }
          }

          // Connect to the selected channel
          connectToChannel(channelSelect.value);
        } else {
          const item = document.createElement("div");
          item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
          appendLog(item);
        }
      };
    </script>
    <style>
      html {
        overflow: hidden;
      }

      body {
        overflow: hidden;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        background: gray;
      }

      #log {
        background: white;
        margin: 0;
        padding: 0.5em 0.5em 0.5em 0.5em;
        position: absolute;
        top: 3.5em; /* Adjusted to make room for the channel selection */
        left: 0.5em;
        right: 0.5em;
        bottom: 3em;
        overflow: auto;
      }

      #channel-container {
        position: absolute;
        top: 0.5em;
        left: 0.5em;
        right: 0.5em;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      #form {
        padding: 0 0.5em 0 0.5em;
        margin: 0;
        position: absolute;
        bottom: 1em;
        left: 0px;
        width: 100%;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="channel-container" style="background-color: #f0f0f0; padding: 10px; margin-bottom: 5px; display: flex; align-items: center;">
      <label for="channel" style="margin-right: 10px;">Channel:</label>
      <select id="channel" style="margin-right: 10px; padding: 5px;">
        <option value="">General</option>
        <option value="announcements">Announcements</option>
        <option value="support">Support</option>
        <option value="random">Random</option>
      </select>
      <button id="newChannelBtn" style="margin-right: 10px; padding: 5px;">New Channel</button>
      <div style="margin-left: auto;">
        Current Channel: <span id="currentChannel" style="font-weight: bold;">General</span>
      </div>
    </div>
    <div id="log"></div>
    <form id="form">
      <input type="submit" value="Send" />
      <label for="msg"><input type="text" id="msg" size="64" autofocus /></label>
    </form>
    <script type="text/javascript">
        // Function to get query parameters from the URL
      function getQueryParams(qs) {
        qs = qs.split('+').join(' ');

        let params = {},
                tokens,
                re = /[?&]?([^=]+)=([^&]*)/g;

        while (tokens = re.exec(qs)) {
          params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
        }

        return params;
      }

        // Function to generate a random string of specified length
      function generateRandomString(length) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length);
          result += characters.charAt(randomIndex);
        }
        return result;
      }

      // Check if the URL contains the 'auto' query parameter
      // If 'auto' is true, automatically send messages every 10 seconds
      const query = getQueryParams(document.location.search);
      if (query.auto === 'true') {
        const button = document.querySelector('input[type="submit"]');

        setInterval(function name(params) {
          const msg = document.getElementById("msg");
          msg.value = generateRandomString(50);

          button.click();
        }, 30000);
      }
    </script>
  </body>
</html>
