<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>gFly WebSocket</title>
    <link rel="icon" href="favicon.png"/>

    <script src="websocket.js"></script>
    <script type="text/javascript">
      window.onload = function () {
        let conn;
        const msg = document.getElementById("msg");
        const log = document.getElementById("log");

        function appendLog(item) {
          const doScroll =
                  log.scrollTop > log.scrollHeight - log.clientHeight - 1;
          log.appendChild(item);
          if (doScroll) {
            log.scrollTop = log.scrollHeight - log.clientHeight;
          }
        }

        document.getElementById("form").onsubmit = function () {
          if (!conn) {
            return false;
          }
          if (!msg.value) {
            return false;
          }
          conn.send(msg.value);
          msg.value = "";
          return false;
        };

        if (window["WebSocket"]) {
          conn = new ReconnectingWebSocket("ws://" + document.location.host + "/ws");
          conn.onopen = function (evt) {
              const item = document.createElement("div");
              item.innerHTML = "<b>Connected.</b>";
              appendLog(item);
          };
          conn.onclose = function (evt) {
            const item = document.createElement("div");
            item.innerHTML = "<b>Connection closed.</b>";
            appendLog(item);
          };
          conn.onmessage = function (evt) {
            const messages = evt.data.split("\n");
            for (let i = 0; i < messages.length; i++) {
              const item = document.createElement("div");
              item.innerText = messages[i];
              appendLog(item);
            }
          };
        } else {
          const item = document.createElement("div");
          item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
          appendLog(item);
        }
      };
    </script>
    <style>
      html {
        overflow: hidden;
      }

      body {
        overflow: hidden;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        background: gray;
      }

      #log {
        background: white;
        margin: 0;
        padding: 0.5em 0.5em 0.5em 0.5em;
        position: absolute;
        top: 0.5em;
        left: 0.5em;
        right: 0.5em;
        bottom: 3em;
        overflow: auto;
      }

      #form {
        padding: 0 0.5em 0 0.5em;
        margin: 0;
        position: absolute;
        bottom: 1em;
        left: 0px;
        width: 100%;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="log"></div>
    <form id="form">
      <input type="submit" value="Send" />
      <label for="msg"><input type="text" id="msg" size="64" autofocus /></label>
    </form>
    <script type="text/javascript">
        // Function to get query parameters from the URL
      function getQueryParams(qs) {
        qs = qs.split('+').join(' ');

        let params = {},
                tokens,
                re = /[?&]?([^=]+)=([^&]*)/g;

        while (tokens = re.exec(qs)) {
          params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
        }

        return params;
      }

        // Function to generate a random string of specified length
      function generateRandomString(length) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length);
          result += characters.charAt(randomIndex);
        }
        return result;
      }

      // Check if the URL contains the 'auto' query parameter
      // If 'auto' is true, automatically send messages every 10 seconds
      const query = getQueryParams(document.location.search);
      if (query.auto === 'true') {
        const button = document.querySelector('input[type="submit"]');

        setInterval(function name(params) {
          const msg = document.getElementById("msg");
          msg.value = generateRandomString(50);

          button.click();
        }, 30000);
      }
    </script>
  </body>
</html>
